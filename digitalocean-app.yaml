name: restonext
# Force redeploy for API URL fix
region: nyc1
services:
# ============================================
# Backend API (FastAPI)
# ============================================
- name: api
  source_dir: apps/api
  dockerfile_path: Dockerfile
  github:
    repo: DanielAguilarJ/RestoNext
    branch: main
    deploy_on_push: true
  http_port: 8000
  instance_size_slug: basic-xs
  instance_count: 1
  routes:
  - path: /api
  envs:
  # Database (managed by DO)
  - key: DATABASE_URL
    scope: RUN_TIME
    value: ${db.DATABASE_URL}
  # Redis (managed by DO)
  - key: REDIS_URL
    scope: RUN_TIME
    value: ${redis.REDISS_URL}
  # App Configuration
  - key: SCHEDULER_ENABLED
    scope: RUN_TIME
    value: "true"
  - key: DEBUG
    scope: RUN_TIME
    value: "false"
  - key: SENTRY_ENVIRONMENT
    scope: RUN_TIME
    value: "production"
  # Security
  - key: JWT_SECRET
    scope: RUN_TIME
    type: SECRET
  # CORS - Production domains
  - key: BACKEND_CORS_ORIGINS
    scope: RUN_TIME
    value: '["https://whale-app-i6h36.ondigitalocean.app"]'
  # Frontend URL (for Stripe redirects)
  - key: FRONTEND_URL
    scope: RUN_TIME
    value: https://whale-app-i6h36.ondigitalocean.app
  # ========== STRIPE CONFIGURATION ==========
  - key: STRIPE_SECRET_KEY
    scope: RUN_TIME
    type: SECRET
  - key: STRIPE_WEBHOOK_SECRET
    scope: RUN_TIME
    type: SECRET
  # Stripe Price IDs (create in Stripe Dashboard)
  - key: STRIPE_PRICE_ID_STARTER_MONTHLY
    scope: RUN_TIME
    type: SECRET
  - key: STRIPE_PRICE_ID_STARTER_ANNUAL
    scope: RUN_TIME
    type: SECRET
  - key: STRIPE_PRICE_ID_PROFESSIONAL_MONTHLY
    scope: RUN_TIME
    type: SECRET
  - key: STRIPE_PRICE_ID_PROFESSIONAL_ANNUAL
    scope: RUN_TIME
    type: SECRET
  - key: STRIPE_PRICE_ID_ENTERPRISE_MONTHLY
    scope: RUN_TIME
    type: SECRET
  - key: STRIPE_PRICE_ID_ENTERPRISE_ANNUAL
    scope: RUN_TIME
    type: SECRET
  # ========== EMAIL (SMTP) ==========
  - key: SMTP_HOST
    scope: RUN_TIME
    value: smtp.gmail.com
  - key: SMTP_PORT
    scope: RUN_TIME
    value: "587"
  - key: SMTP_USER
    scope: RUN_TIME
    type: SECRET
  - key: SMTP_PASSWORD
    scope: RUN_TIME
    type: SECRET
  - key: SMTP_FROM_EMAIL
    scope: RUN_TIME
    type: SECRET
  - key: SMTP_FROM_NAME
    scope: RUN_TIME
    value: RestoNext
  health_check:
    http_path: /health
    initial_delay_seconds: 40
    period_seconds: 30
    timeout_seconds: 10
    failure_threshold: 3

# ============================================
# Frontend (Next.js)
# ============================================
- name: web
  source_dir: apps/web
  dockerfile_path: Dockerfile
  github:
    repo: DanielAguilarJ/RestoNext
    branch: main
    deploy_on_push: true
  http_port: 3000
  instance_size_slug: basic-xs
  instance_count: 1
  routes:
  - path: /
  envs:
  # API URL - CRITICAL: Must be absolute for build time
  # DigitalOcean internally routes /api to the api service
  - key: NEXT_PUBLIC_API_URL
    scope: RUN_AND_BUILD_TIME
    value: https://whale-app-i6h36.ondigitalocean.app/api
  # WebSocket URL - base path for WS connections (frontend appends /ws/kitchen, etc.)
  - key: NEXT_PUBLIC_WS_URL
    scope: RUN_AND_BUILD_TIME
    value: wss://whale-app-i6h36.ondigitalocean.app/api
  # Stripe Publishable Key (safe to expose)
  - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
    scope: RUN_AND_BUILD_TIME
    type: SECRET
  health_check:
    http_path: /
    initial_delay_seconds: 30
    period_seconds: 30
    timeout_seconds: 10

# ============================================
# Databases
# ============================================
databases:
- name: db
  engine: PG
  version: "16"
  production: true
  size: db-s-1vcpu-1gb
  num_nodes: 1

- name: redis
  engine: REDIS
  version: "7"
  production: true
  size: db-s-1vcpu-1gb
  num_nodes: 1
